<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Affiliate Links Dashboard</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: white;
    }
    input, button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    input {
      width: 100%;
      margin-bottom: 10px;
      background: #1e293b;
      color: #e2e8f0;
    }
    button {
      cursor: pointer;
      font-weight: bold;
    }
    button.primary {
      background: #fb923c;
      color: black;
    }
    button.secondary {
      background: #334155;
      color: white;
      margin-right: 6px;
    }
    button.danger {
      background: #ef4444;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #334155;
      text-align: left;
    }
    th {
      background: #1e293b;
    }
    img.product-img {
      width: 70px;
      height: 70px;
      object-fit: contain;
      background: #020617;
      border-radius: 6px;
    }
    .mono {
      font-family: monospace;
      word-break: break-all;
    }
    .actions button {
      margin-bottom: 5px;
      width: 120px;
    }
  </style>
</head>

<body>

<h1>Affiliate Links Dashboard</h1>

<div id="status" style="margin-bottom: 10px; color: #4ade80;">
  Loadingâ€¦
</div>

<!-- Input form -->
<input id="urlInput" placeholder="Paste Amazon product URL" />
<input id="titleInput" placeholder="Title (optional if auto)" />
<input id="categoryInput" placeholder="Category (optional, e.g., bags, shoes)" />
<input id="noteInput" placeholder="Note (optional, e.g., Instagram reel, group A)" />

<label style="display:flex;align-items:center;margin:8px 0;">
  <input type="checkbox" id="autoTitle" checked />
  <span style="margin-left:6px;">Auto title from Amazon (recommended)</span>
</label>

<button class="primary" onclick="createLink()">Create affiliate link</button>

<!-- TABLE -->
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Source</th>
      <th>Image</th>
      <th>Title</th>
      <th>Category</th>
      <th>Original URL</th>
      <th>Affiliate URL</th>
      <th>Clicks</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const tbody = document.getElementById("tbody");
const statusEl = document.getElementById("status");

async function loadLinks() {
  const res = await fetch("/api/links/all");
  const json = await res.json();
  if (!json.success) {
    statusEl.textContent = "Failed to load links.";
    return;
  }
  statusEl.textContent = `Loaded ${json.links.length} link(s).`;
  renderLinks(json.links);
}

function renderLinks(links) {
  tbody.innerHTML = "";

  links.forEach(link => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${link.id}</td>
      <td>${link.source}</td>
      <td>${link.imageUrl ? 
          `<img class="product-img" src="${link.imageUrl}" referrerpolicy="no-referrer" />`
          : "No image"}</td>
      <td>${link.title || "-"}</td>
      <td>${link.category || "-"}</td>
      <td class="mono">${link.originalUrl}</td>
      <td class="mono">${link.affiliateUrl}</td>
      <td>${link.clicks || 0} clicks</td>
      <td>${new Date(link.createdAt).toLocaleString()}</td>
      <td class="actions">
        <button class="secondary" onclick="copy('${link.affiliateUrl}')">Copy affiliate URL</button>
        <button class="secondary" onclick="copy('${window.location.origin}/api/links/go/${link.id}')">Copy short link</button>
        <button onclick="window.open('/api/links/go/${link.id}', '_blank')">Open tracked link</button>
        <button class="danger" onclick="deleteLink('${link.id}')">Delete</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

// COPY function
function copy(text) {
  navigator.clipboard.writeText(text);
  alert("Copied!");
}

// CREATE new link
async function createLink() {
  const url = document.getElementById("urlInput").value.trim();
  const title = document.getElementById("titleInput").value.trim();
  const category = document.getElementById("categoryInput").value.trim();
  const note = document.getElementById("noteInput").value.trim();
  const autoTitle = document.getElementById("autoTitle").checked;

  const body = { url, title, category, note, autoTitle };

  const res = await fetch("/api/links/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();

  if (!json.success) {
    alert("Create failed: " + json.message);
    return;
  }

  alert("Created!");
  loadLinks();
}

// DELETE a link
async function deleteLink(id) {
  if (!confirm(`Delete link ${id}?`)) return;

  const res = await fetch(`/api/links/delete/${id}`, { method: "DELETE" });
  const json = await res.json();

  if (!json.success) {
    alert("Failed to delete link: " + json.message);
    return;
  }

  alert("Deleted!");
  loadLinks();
}

loadLinks();
</script>

</body>
</html>
