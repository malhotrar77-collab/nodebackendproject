<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AlwaysOnSale â€“ Deals</title>
    <link rel="stylesheet" href="store.css" />
</head>

<body>
    <header class="topbar">
        <div class="logo">ðŸ”´ ALWAYS <span>ON</span> SALE</div>
        <nav>
            <a href="/AlwaysOnSale" class="active">Store</a>
            <a href="/index.html">Dashboard (admin)</a>
        </nav>
    </header>

    <main class="container">
        <section class="hero">
            <h1>Today's hand-picked deals</h1>
            <p>Amazon engine, Instagram skin. Curated products with tracked links.</p>
            <span class="liveBadge">ðŸŸ¢ LIVE FROM ALWAYSonsale</span>
        </section>

        <section class="filters">
            <button class="filter active" data-category="all">All</button>
            <button class="filter" data-category="clothing">Clothing</button>
            <button class="filter" data-category="tshirts">Tshirts</button>
            <button class="filter" data-category="shoes">Shoes</button>
            <button class="filter" data-category="bags">Bags</button>
            <button class="filter" data-category="electronics">Electronics</button>
            <button class="filter" data-category="jeans">Jeans</button>
            <button class="filter" data-category="laptops">Laptops</button>
        </section>

        <section class="searchSort">
            <input id="searchBox" type="text" placeholder="Search products or category..." />
            <select id="sortSelect">
                <option value="new">Newest first</option>
                <option value="old">Oldest first</option>
                <option value="priceHigh">Price high â†’ low</option>
                <option value="priceLow">Price low â†’ high</option>
            </select>
        </section>

        <p id="statusMessage">Loading deals...</p>

        <div id="grid" class="grid"></div>
    </main>

    <script>
        const grid = document.getElementById("grid");
        const statusMessage = document.getElementById("statusMessage");

        async function fetchLinks() {
            try {
                const r = await fetch("/api/links/all");
                const data = await r.json();

                if (!data.success) throw new Error("Invalid API response");

                statusMessage.textContent = `Showing ${data.links.length} deals.`;

                renderCards(data.links);

            } catch (e) {
                statusMessage.textContent = "Could not load products. Try again in a bit.";
                console.error("Error:", e);
            }
        }

        function renderCards(items) {
            grid.innerHTML = "";

            items.forEach(item => {
                const card = document.createElement("div");
                card.className = "card";

                const imgContainer = document.createElement("div");
                imgContainer.className = "imgContainer";

                const img = document.createElement("img");
                img.src = (item.imageUrl && item.imageUrl.includes("http")) ? item.imageUrl : "";

                img.onload = () => {
                    const ratio = img.naturalWidth / img.naturalHeight;
                    if (ratio < 0.9) img.style.objectFit = "contain";
                    else img.style.objectFit = "cover";
                };

                img.onerror = () => {
                    imgContainer.classList.add("noImg");
                    img.remove();
                };

                imgContainer.appendChild(img);
                card.appendChild(imgContainer);

                card.innerHTML += `
                    <div class="sourceTag">${item.source.toUpperCase()}</div>
                    <h2 class="title">${item.title || "Product"}</h2>
                    <p class="descr">This product is a simple, useful pick for daily life. Easy to add into your routine or lifestyle.</p>

                    <div class="priceArea">
                        ${
                            item.price
                                ? `<strong>â‚¹${item.price}</strong>`
                                : `<span class="noPrice">Best price on Amazon</span>`
                        }
                        <span class="date">${new Date(item.createdAt).toLocaleDateString()}</span>
                    </div>

                    <div class="actions">
                        <a href="/api/links/go/${item.id}" target="_blank" class="buyBtn">Buy on Amazon</a>
                        <button class="copyBtn" onclick="copy('${item.affiliateUrl}')">Copy link</button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function copy(text) {
            navigator.clipboard.writeText(text);
            alert("Copied!");
        }

        fetchLinks();
    </script>
</body>
</html>