<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlwaysOnSale – Deals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="store.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
</head>
<body>
<header class="store-shell">

  <!-- Top bar -->
  <div class="store-topbar">
    <div class="brand-pill">
      <span class="dot dot-live"></span>
      <span class="brand-text-1">ALWAYS</span>
      <span class="brand-text-2">ON</span>
      <span class="brand-text-3">SALE</span>
    </div>

    <nav class="store-nav">
      <a class="nav-link nav-link-active" href="/AlwaysOnSale">Store</a>
      <a class="nav-link" href="/">Dashboard (admin)</a>
    </nav>
  </div>

  <main class="store-main">

    <!-- Hero -->
    <section class="hero-card">
      <div class="hero-text">
        <h1>Today’s hand-picked deals</h1>
        <p class="hero-subtitle">
          Amazon engine, Instagram skin. Curated products with tracked links.
        </p>
      </div>

      <div class="hero-status">
        <div class="status-pill status-live">
          <span class="status-dot"></span>
          <span class="status-text">LIVE FROM ALWAYSonsale</span>
        </div>
        <p class="status-caption">
          Showing curated deals. Auto-updated via your affiliate dashboard.
        </p>
      </div>
    </section>

    <!-- Filters -->
    <section class="filters-row">
      <div id="category-pills" class="category-pills"></div>

      <div class="search-sort-row">
        <input
          id="search-input"
          type="search"
          placeholder="Search products or category..."
        />

        <select id="sort-select">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="clicks-desc">Most clicks</option>
        </select>
      </div>
    </section>

    <!-- Meta -->
    <section class="meta-row">
      <p id="stats-text">Showing 0 deal(s).</p>
      <p id="error-text" class="hidden">
        Could not load products. Please try again in a bit.
      </p>
    </section>

    <!-- Grid -->
    <section class="grid-shell">
      <div id="deals-grid" class="deals-grid"></div>
    </section>

  </main>

  <footer class="store-footer">
    AlwaysOnSale · Amazon engine, Instagram skin.
  </footer>
</header>

<script>
/* ---------------- CONFIG ---------------- */
const API_BASE = "/api/links";

const CATEGORIES = [
  { key: "all", label: "All" },
  { key: "clothing", label: "Clothing" },
  { key: "tshirts", label: "Tshirts" },
  { key: "shoes", label: "Shoes" },
  { key: "bags", label: "Bags" },
  { key: "electronics", label: "Electronics" },
  { key: "jeans", label: "Jeans" },
  { key: "laptops", label: "Laptops" },
  { key: "home & living", label: "Home & Living" },
  { key: "other", label: "Other" }
];

const state = {
  all: [],
  filtered: [],
  category: "all",
  search: "",
  sort: "newest"
};

const grid = document.getElementById("deals-grid");
const stats = document.getElementById("stats-text");
const error = document.getElementById("error-text");

/* ---------------- HELPERS ---------------- */
const esc = s =>
  (s || "").replace(/[&<>"']/g, m =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])
  );

/* ---------------- CATEGORIES ---------------- */
function renderCategories() {
  const wrap = document.getElementById("category-pills");
  wrap.innerHTML = "";
  CATEGORIES.forEach(c => {
    const b = document.createElement("button");
    b.className = "pill" + (c.key === state.category ? " pill-active" : "");
    b.textContent = c.label;
    b.onclick = () => {
      state.category = c.key;
      renderCategories();
      render();
    };
    wrap.appendChild(b);
  });
}

/* ---------------- RENDER ---------------- */
function render() {
  let list = [...state.all];

  if (state.category !== "all") {
    list = list.filter(i => (i.category || "other") === state.category);
  }

  if (state.search) {
    const q = state.search.toLowerCase();
    list = list.filter(i =>
      (i.title || "").toLowerCase().includes(q) ||
      (i.note || "").toLowerCase().includes(q)
    );
  }

  state.filtered = list;
  stats.textContent = `Showing ${list.length} deal(s).`;

  grid.innerHTML = list.map(buildCard).join("");
}

/* ---------------- CARD ---------------- */
function buildCard(l) {
  const desc =
    l.longDescription ||
    l.note ||
    "A useful everyday product worth checking out.";

  return `
  <article class="deal-card">
    <div class="deal-card-image">
      ${l.imageUrl ? `<img src="${l.imageUrl}" loading="lazy">` : ""}
    </div>

    <div class="deal-card-body">
      <h2 class="deal-title">${esc(l.title)}</h2>

      <p class="deal-description">${esc(desc)}</p>
      <div class="read-more-btn">More</div>

      <div class="price-row">
        <div class="price-label">Best price on Amazon</div>
        <div class="price-amount">₹${l.price || "—"}</div>
      </div>

      <div class="meta-row-card">
        <span>${l.createdAt ? new Date(l.createdAt).toDateString() : ""}</span>
        <span>${l.clicks || 0} clicks</span>
      </div>
    </div>

    <footer class="deal-card-footer">
      <button class="btn btn-primary" onclick="go('${l.id || l._id}')">
        Buy on Amazon
      </button>
      <button class="btn btn-secondary" onclick="copy('${l.id || l._id}')">
        Copy link
      </button>
    </footer>
  </article>
  `;
}

/* ---------------- ACTIONS ---------------- */
function go(id) {
  window.open(`${API_BASE}/go/${id}`, "_blank");
}

function copy(id) {
  navigator.clipboard.writeText(location.origin + `/api/links/go/${id}`);
}

/* ---------------- LOAD ---------------- */
async function load() {
  try {
    const r = await fetch(`${API_BASE}/all`);
    const j = await r.json();
    state.all = j.links || [];
    render();
  } catch {
    error.classList.remove("hidden");
  }
}

/* ---------------- EVENTS ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  renderCategories();
  load();

  document.getElementById("search-input").oninput =
    e => (state.search = e.target.value, render());

  document.getElementById("sort-select").onchange =
    e => (state.sort = e.target.value, render());
});

/* ---------------- MOBILE: READ MORE ---------------- */
document.addEventListener("click", e => {
  if (!e.target.classList.contains("read-more-btn")) return;

  const desc = e.target.previousElementSibling;
  desc.classList.toggle("expanded");
  e.target.textContent = desc.classList.contains("expanded") ? "Less" : "More";
});
</script>
</body>
</html>