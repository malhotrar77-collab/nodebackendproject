<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlwaysOnSale – Deals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="store.css" />
</head>
<body>
  <div class="page">
    <!-- Top navigation -->
    <header class="top-nav">
      <div class="brand">
        <span class="brand-dot"></span>
        <span class="brand-text">ALWAYS <span>ON</span> SALE</span>
      </div>
      <nav class="top-links">
        <a href="/store.html" class="nav-pill nav-pill-active">Store</a>
        <a href="/" class="nav-pill nav-link-secondary">Dashboard (admin)</a>
      </nav>
    </header>

    <!-- Hero / header section -->
    <section class="hero">
      <div class="hero-card">
        <div class="hero-text-block">
          <h1 class="hero-title">Today&apos;s hand-picked deals</h1>
          <p class="hero-subtitle">
            Amazon engine, Instagram skin. Curated products with tracked links.
          </p>
        </div>
        <div class="hero-status">
          <span class="live-dot"></span>
          <span class="live-label">LIVE FROM ALWAYSonsale</span>
          <span class="live-caption">
            Showing curated deals. Auto-updated via your affiliate dashboard.
          </span>
        </div>
      </div>
    </section>

    <!-- Filters -->
    <section class="filters">
      <div class="pill-row" id="categoryPills">
        <button class="filter-pill pill-active" data-category="all">All</button>
        <button class="filter-pill" data-category="clothing">Clothing</button>
        <button class="filter-pill" data-category="tshirts">Tshirts</button>
        <button class="filter-pill" data-category="shoes">Shoes</button>
        <button class="filter-pill" data-category="bags">Bags</button>
        <button class="filter-pill" data-category="electronics">Electronics</button>
        <button class="filter-pill" data-category="jeans">Jeans</button>
        <button class="filter-pill" data-category="laptops">Laptops</button>
        <button class="filter-pill" data-category="home & living">Home &amp; Living</button>
        <button class="filter-pill" data-category="other">Other</button>
      </div>

      <div class="search-sort-row">
        <div class="search-wrapper">
          <input
            id="searchBox"
            type="text"
            placeholder="Search products or category..."
          />
        </div>
        <div class="sort-wrapper">
          <label for="sortSelect" class="sort-label">Sort</label>
          <select id="sortSelect">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="priceLow">Price: low to high</option>
            <option value="priceHigh">Price: high to low</option>
            <option value="clicks">Most clicks</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Summary -->
    <section class="summary">
      <span id="dealCount">Showing 0 deal(s).</span>
    </section>

    <!-- Deals grid -->
    <main class="grid-section">
      <div id="dealsGrid" class="deals-grid">
        <!-- cards injected by JS -->
      </div>

      <div id="errorMessage" class="error-message" style="display:none;">
        Could not load products. Please try again in a bit.
      </div>
    </main>

    <!-- Footer note -->
    <footer class="footer">
      <span>AlwaysOnSale • Amazon engine, Instagram skin.</span>
    </footer>
  </div>

  <!-- ====== PAGE SCRIPT ====== -->
  <script>
    // ---- State ----
    let allLinks = [];
    let filteredLinks = [];
    let activeCategory = "all";
    let searchTerm = "";
    let sortMode = "newest";

    // ---- Helpers ----
    function niceCategoryLabel(raw) {
      if (!raw) return "OTHER";
      const t = String(raw).toLowerCase().trim();
      if (t === "tshirts" || t === "tshirt") return "TSHIRTS";
      if (t === "home" || t === "home & living") return "HOME & LIVING";
      return t.charAt(0).toUpperCase() + t.slice(1);
    }

    function formatDate(d) {
      if (!d) return "";
      const date = new Date(d);
      if (Number.isNaN(date.getTime())) return "";
      return date.toLocaleDateString("en-IN", {
        day: "2-digit",
        month: "short",
        year: "numeric",
      });
    }

    function formatPrice(value, currency) {
      if (typeof value !== "number") return "Price not available";
      const cur = (currency || "INR").toUpperCase();
      if (cur === "INR") {
        return "₹" + value.toLocaleString("en-IN");
      }
      return value.toLocaleString("en-IN", {
        style: "currency",
        currency: cur,
      });
    }

    function getCardImage(link) {
      if (link.imageUrl) return link.imageUrl;
      if (Array.isArray(link.images) && link.images.length > 0) {
        return link.images[0];
      }
      return "";
    }

    function getCategoryKey(link) {
      return (link.category || "other").toString().toLowerCase().trim();
    }

    // ---- Filtering + sorting ----
    function applyFilters() {
      filteredLinks = allLinks.filter((link) => {
        // Category filter
        if (activeCategory !== "all") {
          if (getCategoryKey(link) !== activeCategory) return false;
        }

        // Search filter
        if (searchTerm) {
          const haystack = (
            (link.title || "") +
            " " +
            (link.category || "") +
            " " +
            (link.note || "")
          ).toLowerCase();
          if (!haystack.includes(searchTerm.toLowerCase())) return false;
        }

        return true;
      });

      // Sorting
      filteredLinks.sort((a, b) => {
        const dateA = new Date(a.createdAt || a.created || 0).getTime();
        const dateB = new Date(b.createdAt || b.created || 0).getTime();
        const priceA =
          typeof a.price === "number" ? a.price : Number.POSITIVE_INFINITY;
        const priceB =
          typeof b.price === "number" ? b.price : Number.POSITIVE_INFINITY;
        const clicksA = typeof a.clicks === "number" ? a.clicks : 0;
        const clicksB = typeof b.clicks === "number" ? b.clicks : 0;

        switch (sortMode) {
          case "oldest":
            return dateA - dateB;
          case "priceLow":
            return priceA - priceB;
          case "priceHigh":
            return priceB - priceA;
          case "clicks":
            return clicksB - clicksA;
          case "newest":
          default:
            return dateB - dateA;
        }
      });
    }

    // ---- Rendering ----
    function renderGrid() {
      const grid = document.getElementById("dealsGrid");
      const countLabel = document.getElementById("dealCount");

      grid.innerHTML = "";

      countLabel.textContent = `Showing ${filteredLinks.length} deal(s).`;

      filteredLinks.forEach((link) => {
        const img = getCardImage(link);
        const title = link.title || "Product";
        const desc =
          link.note ||
          "This product is a simple, useful pick for daily life. Easy to add into your routine or lifestyle.";
        const catKey = getCategoryKey(link);
        const catLabel = niceCategoryLabel(link.category);
        const priceText = formatPrice(link.price, link.priceCurrency);
        const dateText = formatDate(link.lastCheckedAt || link.createdAt);
        const clicks = typeof link.clicks === "number" ? link.clicks : 0;
        const sourceLabel = (link.source || "amazon").toUpperCase();
        const id = link.id || link._id;
        const goUrl = `/api/links/go/${id}`;

        const card = document.createElement("article");
        card.className = "deal-card";
        card.setAttribute("data-category", catKey);

        card.innerHTML = `
          <div class="card-top-row">
            <span class="pill pill-source">${sourceLabel}</span>
            <span class="pill pill-category">${catLabel}</span>
          </div>

          <div class="card-media">
            ${
              img
                ? `<img src="${img}" alt="${title} Image" loading="lazy" />`
                : `<div class="no-image">No image</div>`
            }
          </div>

          <div class="card-body">
            <div class="deal-title" title="${title}">${title}</div>
            <div class="deal-desc">${desc}</div>

            <div class="price-block">
              <div class="price-label">Best price on Amazon</div>
              <div class="price-value">${priceText}</div>
              ${
                dateText
                  ? `<div class="price-meta">Final price shown on Amazon page • ${dateText}</div>`
                  : ``
              }
              <div class="clicks-meta">${clicks} click${
          clicks === 1 ? "" : "s"
        }</div>
            </div>
          </div>

          <div class="card-footer">
            <button class="primary-btn buy-btn">Buy on Amazon</button>
            <button class="secondary-btn copy-btn">Copy link</button>
          </div>
        `;

        // Button actions
        const buyBtn = card.querySelector(".buy-btn");
        const copyBtn = card.querySelector(".copy-btn");

        if (buyBtn) {
          buyBtn.addEventListener("click", () => {
            window.open(goUrl, "_blank", "noopener");
          });
        }

        if (copyBtn) {
          copyBtn.addEventListener("click", async () => {
            try {
              const urlToCopy = window.location.origin + goUrl;
              await navigator.clipboard.writeText(urlToCopy);
              copyBtn.textContent = "Copied!";
              setTimeout(() => {
                copyBtn.textContent = "Copy link";
              }, 1400);
            } catch (e) {
              console.error("Clipboard failed", e);
              alert("Could not copy link. Please copy it manually.");
            }
          });
        }

        grid.appendChild(card);
      });
    }

    // ---- Event wiring ----
    function wireUI() {
      // Category pills
      document
        .getElementById("categoryPills")
        .addEventListener("click", (ev) => {
          const btn = ev.target.closest(".filter-pill");
          if (!btn) return;
          activeCategory = btn.dataset.category || "all";

          document
            .querySelectorAll(".filter-pill")
            .forEach((b) => b.classList.remove("pill-active"));
          btn.classList.add("pill-active");

          applyFilters();
          renderGrid();
        });

      // Search
      document.getElementById("searchBox").addEventListener("input", (ev) => {
        searchTerm = ev.target.value.trim();
        applyFilters();
        renderGrid();
      });

      // Sort
      document.getElementById("sortSelect").addEventListener("change", (ev) => {
        sortMode = ev.target.value;
        applyFilters();
        renderGrid();
      });
    }

    // ---- Initial load ----
    async function init() {
      wireUI();
      const errorBox = document.getElementById("errorMessage");

      try {
        const res = await fetch("/api/links/all");
        const data = await res.json();

        if (!data || data.success === false || !Array.isArray(data.links)) {
          console.error("Unexpected API response", data);
          errorBox.style.display = "block";
          return;
        }

        allLinks = data.links;
        applyFilters();
        renderGrid();
      } catch (err) {
        console.error("Error loading links", err);
        errorBox.style.display = "block";
      }
    }

    init();
  </script>
</body>
</html>