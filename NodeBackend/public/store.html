<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AlwaysOnSale ‚Äì Deals</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #050816;
        --bg-elevated: #0b1020;
        --bg-elevated-soft: #12172a;
        --accent: #ff4b4b;
        --accent-soft: #ff8f5c;
        --accent-pill: #ff3b6a;
        --accent-pill-soft: rgba(255, 59, 106, 0.15);
        --text: #f5f7ff;
        --text-soft: #a4b0d0;
        --pill-bg: #151b2e;
        --pill-bg-active: #ff3b6a;
        --pill-text-active: #ffffff;
        --border-subtle: rgba(255, 255, 255, 0.04);
        --card-border: rgba(255, 255, 255, 0.06);
        --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
        --radius-xl: 22px;
        --radius-lg: 18px;
        --radius-pill: 999px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: radial-gradient(circle at top left, #182848 0, #050816 50%, #02030a 100%);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .page-shell {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      /* Top nav */
      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
        gap: 16px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .brand-dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #ffcf71, #ff4b4b);
        box-shadow: 0 0 0 6px rgba(255, 75, 75, 0.18);
      }

      .brand-text {
        font-size: 16px;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .brand-text span {
        color: var(--text);
        font-weight: 600;
      }

      .nav-links {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
      }

      .nav-pill {
        padding: 6px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.4);
        color: var(--text-soft);
      }

      .nav-pill--active {
        background: linear-gradient(135deg, #ff8f5c, #ff3b6a);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 10px 26px rgba(255, 59, 106, 0.55);
      }

      /* Hero header */
      .hero-card {
        border-radius: 26px;
        padding: 20px 22px 18px;
        background: radial-gradient(circle at top left, #202b46 0, #0a0f1f 40%, #050816 100%);
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: var(--shadow-soft);
        margin-bottom: 24px;
      }

      .hero-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 8px;
      }

      .hero-title {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .hero-subtitle {
        font-size: 13px;
        color: var(--text-soft);
        max-width: 360px;
        line-height: 1.5;
      }

      .live-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 500;
        background: rgba(20, 167, 108, 0.12);
        color: #4af2a1;
        border: 1px solid rgba(74, 242, 161, 0.5);
      }

      .live-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #4af2a1;
        box-shadow: 0 0 0 5px rgba(74, 242, 161, 0.3);
      }

      /* Filter bar */
      .filter-bar {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 18px;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .chip {
        font-size: 11px;
        padding: 6px 12px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--border-subtle);
        background: var(--pill-bg);
        color: var(--text-soft);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .chip-dot {
        width: 5px;
        height: 5px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.24);
      }

      .chip--active {
        background: var(--pill-bg-active);
        color: var(--pill-text-active);
        border-color: rgba(0, 0, 0, 0.3);
      }

      .chip--active .chip-dot {
        background: #fff;
      }

      .search-sort-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .search-input {
        flex: 1;
        min-width: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 999px;
        background: rgba(8, 13, 26, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-soft);
        font-size: 13px;
      }

      .search-input input {
        border: none;
        outline: none;
        background: transparent;
        color: inherit;
        font-size: inherit;
        width: 100%;
      }

      .search-input input::placeholder {
        color: rgba(162, 173, 210, 0.7);
      }

      .sort-select {
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(5, 8, 22, 0.95);
        color: var(--text-soft);
      }

      /* Status text */
      .status-text {
        font-size: 12px;
        color: #70f0b6;
        margin-bottom: 6px;
      }

      .status-text span {
        color: var(--text-soft);
      }

      .error-text {
        font-size: 12px;
        color: #ff6b81;
        margin: 4px 0 10px;
      }

      /* Grid */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 18px;
      }

      .product-card {
        position: relative;
        border-radius: var(--radius-xl);
        background: radial-gradient(circle at top left, #20263f 0, #0a0f1f 40%, #050816 100%);
        border: 1px solid var(--card-border);
        padding: 10px 10px 14px;
        box-shadow: var(--shadow-soft);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease,
          background 0.18s ease;
      }

      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
        border-color: rgba(255, 255, 255, 0.16);
        background: radial-gradient(circle at top left, #263457 0, #0a1022 40%, #050816 100%);
      }

      .product-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .source-pill {
        font-size: 10px;
        padding: 5px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-soft);
      }

      .category-pill {
        font-size: 10px;
        padding: 5px 10px;
        border-radius: 999px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(1, 6, 24, 0.8);
        color: #a6b4ff;
      }

      .product-card-image-wrapper {
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: radial-gradient(circle at top left, #1b2035 0, #050816 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }

      .product-image {
        width: 100%;
        height: 260px;
        object-fit: cover;
        display: block;
      }

      .product-image--placeholder {
        height: 260px;
        flex-direction: column;
      }

      .product-image--placeholder .placeholder-icon {
        font-size: 32px;
        opacity: 0.9;
      }

      .product-image--placeholder .placeholder-text {
        font-size: 11px;
        color: rgba(180, 192, 230, 0.8);
        margin-top: 4px;
      }

      .product-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .product-description {
        font-size: 11px;
        color: var(--text-soft);
        line-height: 1.5;
        min-height: 2.8em;
        margin-bottom: 6px;
      }

      .product-meta {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 11px;
        margin-bottom: 6px;
        color: var(--text-soft);
      }

      .price-text {
        font-size: 13px;
        font-weight: 600;
        color: #ffcf71;
      }

      .price-caption {
        font-size: 10px;
        color: rgba(182, 193, 230, 0.9);
      }

      .date-clicks {
        text-align: right;
        font-size: 10px;
      }

      .clicks-badge {
        margin-top: 2px;
        padding: 2px 7px;
        border-radius: 999px;
        background: rgba(6, 214, 160, 0.1);
        color: #4af2a1;
        display: inline-block;
      }

      .product-footer {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 8px;
      }

      .btn-primary {
        flex: 1;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        padding: 9px 14px;
        background: radial-gradient(circle at 20% 0, #ffd26f, #ff4b4b);
        color: #1a090d;
        box-shadow: 0 10px 26px rgba(255, 75, 75, 0.65);
      }

      .btn-secondary {
        flex-basis: 82px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(2, 6, 23, 0.9);
        color: var(--text-soft);
        font-size: 11px;
        cursor: pointer;
        padding: 8px 10px;
      }

      .empty-state {
        padding: 32px 16px;
        text-align: center;
        font-size: 13px;
        color: var(--text-soft);
      }

      .empty-state strong {
        color: #fff;
      }

      @media (max-width: 768px) {
        .page-shell {
          padding: 18px 12px 32px;
        }

        .hero-card {
          padding: 18px 16px 16px;
        }

        .hero-title {
          font-size: 20px;
        }

        .product-image,
        .product-image--placeholder {
          height: 220px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-shell">
      <header class="top-nav">
        <div class="brand">
          <div class="brand-dot"></div>
          <div class="brand-text">
            ALWAYS <span>ON SALE</span>
          </div>
        </div>
        <nav class="nav-links">
          <a href="/AlwaysOnSale" class="nav-pill nav-pill--active">Store</a>
          <a href="/" class="nav-pill">Dashboard (admin)</a>
        </nav>
      </header>

      <section class="hero-card">
        <div class="hero-title-row">
          <div>
            <div class="hero-title">Today‚Äôs hand-picked deals</div>
            <div class="hero-subtitle">
              Amazon engine, Instagram skin. Curated products with tracked links.
            </div>
          </div>
          <div class="live-pill">
            <span class="live-dot"></span>
            LIVE FROM ALWAYSOnSALE
          </div>
        </div>
      </section>

      <section class="filter-bar">
        <div class="chip-row" id="categoryChips">
          <button class="chip chip--active" data-category="all">
            <span class="chip-dot"></span>
            All
          </button>
          <button class="chip" data-category="shoes">
            <span class="chip-dot"></span>
            Shoes & Sneakers
          </button>
          <button class="chip" data-category="clothing">
            <span class="chip-dot"></span>
            Clothing
          </button>
          <button class="chip" data-category="bags">
            <span class="chip-dot"></span>
            Bags & Backpacks
          </button>
          <button class="chip" data-category="beauty">
            <span class="chip-dot"></span>
            Beauty & Hair
          </button>
          <button class="chip" data-category="personal-care">
            <span class="chip-dot"></span>
            Personal Care
          </button>
          <button class="chip" data-category="electronics">
            <span class="chip-dot"></span>
            Electronics (Mobiles, Laptops, Audio)
          </button>
          <button class="chip" data-category="home">
            <span class="chip-dot"></span>
            Home & Living
          </button>
          <button class="chip" data-category="other">
            <span class="chip-dot"></span>
            Other
          </button>
        </div>

        <div class="search-sort-row">
          <div class="search-input">
            <span>üîç</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search products or category‚Ä¶"
              autocomplete="off"
            />
          </div>

          <select id="sortSelect" class="sort-select">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="price-high">Price: High ‚Üí Low</option>
            <option value="price-low">Price: Low ‚Üí High</option>
            <option value="clicks">Most clicked</option>
          </select>
        </div>
      </section>

      <div id="statusText" class="status-text">Loading curated deals‚Ä¶</div>
      <div id="errorText" class="error-text" style="display: none;"></div>

      <section id="productsGrid" class="grid"></section>

      <div id="emptyState" class="empty-state" style="display: none;">
        <strong>No deals match your filters.</strong><br />
        Try clearing the search or switching categories.
      </div>
    </div>

    <script>
      const API_BASE = "/api/links";

      let allLinks = [];
      let filteredLinks = [];
      let activeCategory = "all";
      let activeSort = "newest";
      let searchQuery = "";

      const gridEl = document.getElementById("productsGrid");
      const statusEl = document.getElementById("statusText");
      const errorEl = document.getElementById("errorText");
      const emptyStateEl = document.getElementById("emptyState");
      const categoryChipsEl = document.getElementById("categoryChips");
      const sortSelectEl = document.getElementById("sortSelect");
      const searchInputEl = document.getElementById("searchInput");

      function decodeHtml(str) {
        if (!str) return "";
        const txt = document.createElement("textarea");
        txt.innerHTML = str;
        return txt.value;
      }

      function formatPrice(price) {
        if (price === null || price === undefined || isNaN(price)) return "";
        try {
          const n = Number(price);
          return "‚Çπ" + n.toLocaleString("en-IN");
        } catch (e) {
          return "";
        }
      }

      function formatDate(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "";
        return d.toLocaleDateString("en-IN", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      function computeCategory(link) {
        const cat = (link.category || "").toLowerCase();
        if (!cat || cat === "-" || cat === "other") return "other";
        if (cat.includes("shoe")) return "shoes";
        if (cat.includes("sneaker")) return "shoes";
        if (cat.includes("shirt") || cat.includes("tshirt") || cat.includes("t-shirt")) return "clothing";
        if (cat.includes("bag")) return "bags";
        if (cat.includes("beauty") || cat.includes("hair")) return "beauty";
        if (cat.includes("personal")) return "personal-care";
        if (cat.includes("electro") || cat.includes("laptop") || cat.includes("mobile")) return "electronics";
        if (cat.includes("home") || cat.includes("living")) return "home";
        return "other";
      }

      function prettifyCategory(cat) {
        switch (cat) {
          case "shoes":
            return "Shoes & Sneakers";
          case "clothing":
            return "Clothing";
          case "bags":
            return "Bags & Backpacks";
          case "beauty":
            return "Beauty & Hair";
          case "personal-care":
            return "Personal Care";
          case "electronics":
            return "Electronics";
          case "home":
            return "Home & Living";
          case "other":
          default:
            return "Other";
        }
      }

      function applyFilters() {
        const q = searchQuery.trim().toLowerCase();

        filteredLinks = allLinks.filter((link) => {
          const cat = computeCategory(link);
          if (activeCategory !== "all" && cat !== activeCategory) return false;

          if (!q) return true;

          const text = [
            decodeHtml(link.title || ""),
            decodeHtml(link.note || ""),
            link.category || "",
            link.tag || "",
          ]
            .join(" ")
            .toLowerCase();

          return text.includes(q);
        });

        // sort
        filteredLinks.sort((a, b) => {
          if (activeSort === "newest") {
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          }
          if (activeSort === "oldest") {
            return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
          }
          if (activeSort === "price-high") {
            return (b.price || 0) - (a.price || 0);
          }
          if (activeSort === "price-low") {
            return (a.price || 0) - (b.price || 0);
          }
          if (activeSort === "clicks") {
            return (b.clicks || 0) - (a.clicks || 0);
          }
          return 0;
        });

        renderProducts();
      }

      function renderProducts() {
        statusEl.textContent = `Showing ${
          filteredLinks.length
        } curated deal${filteredLinks.length === 1 ? "" : "s"}.`;

        if (filteredLinks.length === 0) {
          gridEl.innerHTML = "";
          emptyStateEl.style.display = "block";
          return;
        }

        emptyStateEl.style.display = "none";

        const cardsHtml = filteredLinks
          .map((link) => {
            const title = decodeHtml(link.title || "Product").trim() || "Product";
            const desc = decodeHtml(link.note || "").trim();
            const priceLabel = formatPrice(link.price);
            const created = formatDate(link.createdAt);
            const clicks = Number(link.clicks || 0);
            const catKey = computeCategory(link);
            const catLabel = prettifyCategory(catKey);
            const source = (link.source || "amazon").toUpperCase();

            const hasImage = link.imageUrl && String(link.imageUrl).trim() !== "";

            const imageHtml = hasImage
              ? `<img src="${link.imageUrl}" alt="${title.replace(/"/g, "")}" loading="lazy" class="product-image" />`
              : `<div class="product-image product-image--placeholder">
                  <span class="placeholder-icon">üì¶</span>
                  <span class="placeholder-text">Image coming soon</span>
                 </div>`;

            const priceBlock = priceLabel
              ? `<div>
                  <div class="price-text">${priceLabel}</div>
                  <div class="price-caption">Final price shown on Amazon page</div>
                 </div>`
              : `<div>
                  <div class="price-caption">Best price on Amazon</div>
                 </div>`;

            const dateClicksHtml =
              created || clicks
                ? `<div class="date-clicks">
                    ${created ? `<div>${created}</div>` : ""}
                    ${
                      clicks
                        ? `<div class="clicks-badge">${clicks} click${
                            clicks === 1 ? "" : "s"
                          }</div>`
                        : ""
                    }
                  </div>`
                : "";

            const goUrl = `/api/links/go/${encodeURIComponent(link.id || link._id)}`;

            return `
          <article class="product-card">
            <div class="product-card-header">
              <div class="source-pill">${source}</div>
              <div class="category-pill">${catLabel}</div>
            </div>
            <div class="product-card-image-wrapper">
              ${imageHtml}
            </div>
            <div class="product-title">${title}</div>
            <div class="product-description">
              ${
                desc ||
                "Best price on Amazon. A simple, useful pick for daily life ‚Äì easy to add into your routine or lifestyle."
              }
            </div>
            <div class="product-meta">
              ${priceBlock}
              ${dateClicksHtml}
            </div>
            <div class="product-footer">
              <button class="btn-primary" onclick="handleBuy('${goUrl}')">
                Buy on Amazon
              </button>
              <button class="btn-secondary" onclick="handleCopy('${window.location.origin}${goUrl}')">
                Copy link
              </button>
            </div>
          </article>
        `;
          })
          .join("");

        gridEl.innerHTML = cardsHtml;
      }

      async function fetchLinks() {
        try {
          statusEl.textContent = "Loading curated deals‚Ä¶";
          errorEl.style.display = "none";
          const resp = await fetch(`${API_BASE}/all`);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();

          if (!Array.isArray(data)) {
            throw new Error("Unexpected API response");
          }

          allLinks = data;
          applyFilters();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "";
          errorEl.textContent =
            "Could not load products. Please try again in a bit.";
          errorEl.style.display = "block";
        }
      }

      function handleBuy(url) {
        window.open(url, "_blank", "noopener");
      }

      async function handleCopy(url) {
        try {
          await navigator.clipboard.writeText(url);
          alert("Link copied!");
        } catch (e) {
          console.error("Clipboard failed", e);
          alert("Could not copy link, please copy from the address bar.");
        }
      }

      // Events
      categoryChipsEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".chip");
        if (!btn) return;
        const cat = btn.getAttribute("data-category");
        if (!cat) return;

        activeCategory = cat;
        document
          .querySelectorAll(".chip")
          .forEach((c) => c.classList.toggle("chip--active", c === btn));

        applyFilters();
      });

      sortSelectEl.addEventListener("change", (e) => {
        activeSort = e.target.value;
        applyFilters();
      });

      searchInputEl.addEventListener("input", (e) => {
        searchQuery = e.target.value || "";
        applyFilters();
      });

      fetchLinks();
    </script>
  </body>
</html>