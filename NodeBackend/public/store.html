<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlwaysOnSale – Deals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="store.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
</head>

<body>
  <!-- ================= HEADER ================= -->
  <header class="store-shell">
    <div class="store-topbar">
      <div class="brand-pill">
        <span class="dot dot-live"></span>
        <span class="brand-text-1">ALWAYS</span>
        <span class="brand-text-2">ON</span>
        <span class="brand-text-3">SALE</span>
      </div>

      <nav class="store-nav">
        <a class="nav-link nav-link-active" href="/AlwaysOnSale">Store</a>
        <a class="nav-link" href="/">Dashboard (admin)</a>
      </nav>
    </div>

    <!-- ================= MAIN ================= -->
    <main class="store-main">

      <!-- HERO -->
      <section class="hero-card">
        <div class="hero-text">
          <h1>Today’s hand-picked deals</h1>
          <p class="hero-subtitle">
            Amazon engine, Instagram skin. Curated products with tracked links.
          </p>
        </div>

        <div class="hero-status">
          <div class="status-pill status-live">
            <span class="status-dot"></span>
            <span>LIVE FROM ALWAYSonsale</span>
          </div>
          <p class="status-caption">
            Showing curated deals. Auto-updated via your affiliate dashboard.
          </p>
        </div>
      </section>

      <!-- FILTERS -->
      <section class="filters-row">
        <div id="category-pills" class="category-pills"></div>

        <div class="search-sort-row">
          <input
            id="search-input"
            type="search"
            placeholder="Search products or category"
          />

          <select id="sort-select">
            <option value="newest">Newest first</option>
            <option value="oldest">Oldest first</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="clicks-desc">Most clicks</option>
          </select>
        </div>
      </section>

      <!-- META -->
      <section class="meta-row">
        <p id="stats-text">Showing 0 deal(s).</p>
        <p id="error-text" class="hidden">
          Could not load products. Please try again in a bit.
        </p>
      </section>

      <!-- GRID -->
      <section class="grid-shell">
        <div id="deals-grid" class="deals-grid"></div>
      </section>
    </main>

    <footer class="store-footer">
      AlwaysOnSale · Amazon engine, Instagram skin.
    </footer>
  </header>

  <!-- ================= SCRIPT ================= -->
  <script>
    const API_BASE = "/api/links";

    const categories = [
      "all",
      "clothing",
      "tshirts",
      "shoes",
      "bags",
      "electronics",
      "jeans",
      "laptops",
      "home & living",
      "other"
    ];

    const state = {
      all: [],
      filtered: [],
      category: "all",
      search: "",
      sort: "newest"
    };

    const grid = document.getElementById("deals-grid");
    const stats = document.getElementById("stats-text");
    const errorText = document.getElementById("error-text");

    /* ---------- Utilities ---------- */
    const esc = (s) =>
      (s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

    const formatDate = (d) =>
      d
        ? new Date(d).toLocaleDateString("en-IN", {
            day: "2-digit",
            month: "short",
            year: "numeric"
          })
        : "";

    const formatPrice = (p) =>
      p
        ? new Intl.NumberFormat("en-IN", {
            style: "currency",
            currency: "INR",
            maximumFractionDigits: 0
          }).format(p)
        : "—";

    /* ---------- Category Pills ---------- */
    function renderCategories() {
      const el = document.getElementById("category-pills");
      el.innerHTML = "";

      categories.forEach((c) => {
        const b = document.createElement("button");
        b.textContent = c === "all" ? "All" : c.replace(/^\w/, m => m.toUpperCase());
        b.className = "pill" + (state.category === c ? " pill-active" : "");
        b.onclick = () => {
          state.category = c;
          renderCategories();
          render();
        };
        el.appendChild(b);
      });
    }

    /* ---------- Card ---------- */
    function card(link) {
      const desc =
        link.longDescription ||
        link.note ||
        "A useful product curated for everyday value.";

      return `
      <article class="deal-card">
        <div class="deal-card-image">
          ${
            link.imageUrl
              ? `<img src="${link.imageUrl}" loading="lazy" />`
              : `<div class="no-image">No image</div>`
          }
        </div>

        <div class="deal-card-body">
          <h3 class="deal-title">${esc(link.title)}</h3>

          <p class="deal-description">
            ${esc(desc)}
          </p>
          <span class="read-more-btn">More</span>

          <div class="price-row">
            <div class="price-label">Best price on Amazon</div>
            <div class="price-amount">${formatPrice(link.price)}</div>
          </div>

          <div class="meta-row-card">
            <span>${formatDate(link.createdAt)}</span>
            <span>${link.clicks || 0} clicks</span>
          </div>
        </div>

        <div class="deal-card-footer">
          <button class="btn btn-primary" data-buy="${link.id}">Buy</button>
          <button class="btn btn-secondary" data-copy="${link.id}">Copy</button>
        </div>
      </article>`;
    }

    /* ---------- Render ---------- */
    function render() {
      let list = [...state.all];

      if (state.category !== "all") {
        list = list.filter(
          (l) => (l.category || "").toLowerCase() === state.category
        );
      }

      if (state.search) {
        list = list.filter((l) =>
          (l.title || "").toLowerCase().includes(state.search)
        );
      }

      stats.textContent = `Showing ${list.length} deal(s).`;
      grid.innerHTML = list.map(card).join("");
    }

    /* ---------- Fetch ---------- */
    async function load() {
      try {
        const r = await fetch(API_BASE + "/all");
        const j = await r.json();
        state.all = j.links || [];
        render();
      } catch {
        errorText.classList.remove("hidden");
      }
    }

    /* ---------- EVENTS ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      renderCategories();
      load();

      document.getElementById("search-input").oninput = (e) => {
        state.search = e.target.value.toLowerCase();
        render();
      };

      document.getElementById("sort-select").onchange = (e) => {
        state.sort = e.target.value;
        render();
      };
    });

    /* ---------- READ MORE (MOBILE SAFE) ---------- */
    document.addEventListener("click", (e) => {
      if (!e.target.classList.contains("read-more-btn")) return;

      const card = e.target.closest(".deal-card");
      const desc = card.querySelector(".deal-description");

      desc.classList.toggle("expanded");
      e.target.textContent = desc.classList.contains("expanded")
        ? "Less"
        : "More";
    });
  </script>
</body>
</html>