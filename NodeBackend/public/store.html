<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AlwaysOnSale ‚Äî Deals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/favicon.png" />

  <!-- Google Font (similar to Instagram feel) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #070b1a;
      --bg-card: #0b1021;
      --bg-chip: #111629;
      --bg-chip-active: #f4755e;
      --border-subtle: rgba(255, 255, 255, 0.04);
      --accent: #f4755e;
      --accent-soft: rgba(244, 117, 94, 0.18);
      --accent-strong: #ff5b3e;
      --text-main: #f9fbff;
      --text-muted: #9da8c2;
      --text-soft: #6b748b;
      --text-bad: #ff7b7b;
      --pill-bg: #10182a;
      --badge-amazon: #222f3e;
      --radius-xl: 24px;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 50px rgba(0, 0, 0, 0.7);
      --shadow-subtle: 0 0 0 1px rgba(255, 255, 255, 0.02);
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #141c3b 0, #050816 48%, #02030a 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1280px;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .brand-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffd2aa, #ff5b3e 55%, #a51454);
      box-shadow: 0 0 18px rgba(255, 130, 90, 0.75);
    }

    .nav-links {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--text-soft);
      align-items: center;
    }

    .nav-links a {
      text-decoration: none;
      color: inherit;
      padding: 4px 9px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: 1px solid transparent;
      transition: background var(--transition-fast), color var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast);
    }

    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .nav-links a.active {
      background: rgba(244, 117, 94, 0.15);
      border-color: var(--accent-soft);
      color: #ffeae3;
    }

    main {
      background: linear-gradient(145deg, rgba(9, 15, 35, 0.98), rgba(5, 11, 26, 0.98));
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.03);
      padding: 22px 20px 26px;
    }

    @media (max-width: 720px) {
      main {
        padding: 18px 14px 22px;
        border-radius: 24px;
      }
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .hero-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .hero-title-block h1 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .hero-title-block p {
      font-size: 13px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(86, 201, 137, 0.5);
      background: radial-gradient(circle at 0 50%, rgba(34, 197, 94, 0.25), #071214);
      color: #b9ffd6;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
    }

    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .status-and-count {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-soft);
    }

    #statusMessage {
      color: var(--text-soft);
    }

    #statusMessage.error {
      color: var(--text-bad);
    }

    #dealCount {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(8, 14, 33, 0.95);
      color: var(--text-muted);
      font-size: 11px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .category-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: var(--bg-chip);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
    }

    .chip.active {
      background: var(--bg-chip-active);
      border-color: transparent;
      cursor: default;
      color: #fffaf7;
      box-shadow: 0 10px 24px rgba(244, 117, 94, 0.55);
    }

    .chip.active .chip-dot {
      background: #fff5eb;
    }

    .chip:hover:not(.active) {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.14);
    }

    .search-sort-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 180px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 14px 10px 30px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(9, 14, 32, 0.96);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .search-box input::placeholder {
      color: var(--text-soft);
    }

    .search-box input:focus {
      border-color: rgba(244, 117, 94, 0.6);
      box-shadow: 0 0 0 1px rgba(244, 117, 94, 0.48);
      background: rgba(10, 17, 40, 0.96);
    }

    .search-icon {
      position: absolute;
      left: 11px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--text-soft);
      pointer-events: none;
    }

    .sort-box {
      flex-shrink: 0;
      min-width: 160px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: flex-end;
    }

    .sort-box label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .sort-box select {
      border-radius: 999px;
      padding: 8px 11px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(9, 14, 32, 0.96);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
      cursor: pointer;
    }

    @media (max-width: 720px) {
      .hero-title-block h1 {
        font-size: 20px;
      }

      .search-sort-row {
        flex-direction: column;
        align-items: stretch;
      }

      .sort-box {
        justify-content: flex-start;
      }
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    @media (max-width: 1100px) {
      .products-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 820px) {
      .products-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 540px) {
      .products-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .product-card {
      background: radial-gradient(circle at top left, rgba(244, 117, 94, 0.13), transparent 40%),
        radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.08), transparent 48%),
        var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 10px 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: var(--shadow-subtle);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        border-color var(--transition-fast), background var(--transition-fast);
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 22px 40px rgba(0, 0, 0, 0.9);
      border-color: rgba(244, 117, 94, 0.4);
    }

    .product-badges {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-soft);
    }

    .source-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--badge-amazon);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-weight: 600;
      color: #f3f5ff;
    }

    .category-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-weight: 500;
      color: var(--text-muted);
    }

    .product-media {
      border-radius: 22px;
      background: radial-gradient(circle at top, #1e263f, #090f24 60%);
      overflow: hidden;
      margin-top: 4px;
      min-height: 190px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-media img {
      width: 100%;
      height: 230px;
      object-fit: cover;
      display: block;
      transition: transform 0.25s ease-out;
    }

    .product-card:hover .product-media img {
      transform: scale(1.035);
    }

    .image-placeholder {
      width: 100%;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-soft);
      background: repeating-linear-gradient(
        135deg,
        #0b1020,
        #0b1020 6px,
        #0f1630 6px,
        #0f1630 12px
      );
    }

    .product-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .product-title {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.35;
    }

    .product-description {
      font-size: 11px;
      color: var(--text-soft);
      line-height: 1.45;
      max-height: 3.8em;
      overflow: hidden;
    }

    .product-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .price-label {
      font-weight: 600;
      color: #ffe1cf;
      font-size: 12px;
    }

    .price-note {
      font-size: 10px;
      color: var(--text-soft);
    }

    .clicks-pill {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 10px;
    }

    .clicks-pill strong {
      color: #e0ecff;
      font-weight: 600;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .cta-primary {
      flex: 1;
      border-radius: 999px;
      padding: 9px 12px;
      border: none;
      outline: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #fff;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), filter var(--transition-fast);
      box-shadow: 0 14px 26px rgba(244, 117, 94, 0.7);
    }

    .cta-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 16px 30px rgba(244, 117, 94, 0.85);
    }

    .cta-secondary {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 9px 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(5, 10, 22, 0.9);
      color: var(--text-main);
      font-size: 11px;
      cursor: pointer;
      transition: border-color var(--transition-fast),
        background var(--transition-fast), transform var(--transition-fast);
    }

    .cta-secondary:hover {
      border-color: rgba(255, 255, 255, 0.28);
      background: rgba(9, 16, 32, 0.96);
      transform: translateY(-1px);
    }

    footer {
      margin-top: 10px;
      padding: 0 4px;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    footer a {
      color: var(--text-muted);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-dot"></div>
        ALWAYS<span style="color:#f4755e;">ON</span>SALE
      </div>
      <nav class="nav-links">
        <a href="/AlwaysOnSale" class="active">Store</a>
        <a href="/" title="Admin dashboard">Dashboard (admin)</a>
      </nav>
    </header>

    <main>
      <section class="hero">
        <div class="hero-top">
          <div class="hero-title-block">
            <h1>Today‚Äôs hand-picked deals</h1>
            <p>Amazon engine, Instagram skin. Curated products with tracked links.</p>
          </div>
          <span class="live-badge">
            <span class="live-dot"></span>
            Live from AlwaysOnSale
          </span>
        </div>
        <div class="meta-row">
          <div class="status-and-count">
            <span id="statusMessage">Loading deals‚Ä¶</span>
            <span id="dealCount"></span>
          </div>
        </div>
      </section>

      <section class="controls">
        <div class="category-chips" id="categoryChips">
          <button class="chip active" data-category="all">
            <span class="chip-dot"></span> All
          </button>
          <button class="chip" data-category="shoes">
            <span class="chip-dot"></span> Shoes & Sneakers
          </button>
          <button class="chip" data-category="clothing">
            <span class="chip-dot"></span> Clothing
          </button>
          <button class="chip" data-category="bags">
            <span class="chip-dot"></span> Bags & Backpacks
          </button>
          <button class="chip" data-category="beauty">
            <span class="chip-dot"></span> Beauty & Hair
          </button>
          <button class="chip" data-category="personal care">
            <span class="chip-dot"></span> Personal Care
          </button>
          <button class="chip" data-category="electronics">
            <span class="chip-dot"></span> Electronics (Mobiles, Laptops, Audio)
          </button>
          <button class="chip" data-category="home">
            <span class="chip-dot"></span> Home & Living
          </button>
          <button class="chip" data-category="other">
            <span class="chip-dot"></span> Other
          </button>
        </div>

        <div class="search-sort-row">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input
              id="searchInput"
              type="text"
              placeholder="Search products or category‚Ä¶" />
          </div>

          <div class="sort-box">
            <label for="sortSelect">Sort</label>
            <select id="sortSelect">
              <option value="newest">Newest first</option>
              <option value="oldest">Oldest first</option>
              <option value="priceLowHigh">Price: Low to High</option>
              <option value="priceHighLow">Price: High to Low</option>
              <option value="clicksHighLow">Most clicked</option>
            </select>
          </div>
        </div>
      </section>

      <section id="productsGrid" class="products-grid"></section>
    </main>

    <footer>
      <span>Tracked links powered by AlwaysOnSale.</span>
      <span>Prices & availability may change on Amazon.</span>
    </footer>
  </div>

  <script>
    let allLinks = [];
    const statusEl = document.getElementById("statusMessage");
    const countEl = document.getElementById("dealCount");
    const gridEl = document.getElementById("productsGrid");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function loadProducts() {
      try {
        statusEl.textContent = "Loading deals‚Ä¶";
        statusEl.classList.remove("error");
        const res = await fetch("/api/links/all");
        if (!res.ok) {
          throw new Error("Failed to load products");
        }
        const data = await res.json();
        allLinks = Array.isArray(data) ? data : data.links || [];

        // Default sort: newest first
        allLinks.sort((a, b) => {
          const aDate = new Date(a.createdAt || 0).getTime();
          const bDate = new Date(b.createdAt || 0).getTime();
          return bDate - aDate;
        });

        applyFiltersAndRender();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Could not load products.";
        statusEl.classList.add("error");
        countEl.textContent = "";
        gridEl.innerHTML = "";
      }
    }

    function getActiveCategory() {
      const activeChip = document.querySelector(".chip.active");
      return activeChip ? activeChip.dataset.category : "all";
    }

    function applyFiltersAndRender() {
      const category = getActiveCategory();
      const term = searchInput.value.trim().toLowerCase();
      const sortMode = sortSelect.value;

      let filtered = allLinks.filter((link) => {
        const cat = (link.category || "other").toLowerCase();
        const inCategory =
          category === "all" ||
          cat === category ||
          cat.includes(category);

        const haystack = (
          (link.title || "Product") +
          " " +
          (link.note || "") +
          " " +
          (link.category || "")
        ).toLowerCase();

        const inSearch = !term || haystack.includes(term);
        return inCategory && inSearch;
      });

      // Sorting
      filtered.sort((a, b) => {
        const priceA = typeof a.price === "number" ? a.price : null;
        const priceB = typeof b.price === "number" ? b.price : null;
        const dateA = new Date(a.createdAt || 0).getTime();
        const dateB = new Date(b.createdAt || 0).getTime();
        const clicksA = typeof a.clicks === "number" ? a.clicks : 0;
        const clicksB = typeof b.clicks === "number" ? b.clicks : 0;

        switch (sortMode) {
          case "oldest":
            return dateA - dateB;
          case "priceLowHigh":
            if (priceA == null && priceB == null) return 0;
            if (priceA == null) return 1;
            if (priceB == null) return -1;
            return priceA - priceB;
          case "priceHighLow":
            if (priceA == null && priceB == null) return 0;
            if (priceA == null) return 1;
            if (priceB == null) return -1;
            return priceB - priceA;
          case "clicksHighLow":
            return clicksB - clicksA;
          case "newest":
          default:
            return dateB - dateA;
        }
      });

      renderGrid(filtered);
    }

    function renderGrid(links) {
      gridEl.innerHTML = "";

      const count = links.length;
      if (count === 0) {
        statusEl.textContent = "No products yet. Add links from the Affiliate Links dashboard.";
        statusEl.classList.remove("error");
        countEl.textContent = "";
        return;
      }

      statusEl.textContent = "Showing curated deals.";
      statusEl.classList.remove("error");
      countEl.textContent = `Showing ${count} deal${count === 1 ? "" : "s"}.`;

      links.forEach((link) => {
        const card = document.createElement("article");
        card.className = "product-card";

        const title = link.title && link.title !== "Product"
          ? link.title
          : "Product";

        const note =
          link.note && link.note.trim().length > 0
            ? link.note
            : (link.description || "");

        const sourceLabel = (link.source || "amazon").toUpperCase();
        const categoryLabel =
          (link.category && link.category.length > 0
            ? link.category
            : "other").toUpperCase();

        const imgHtml = link.imageUrl
          ? `<img src="${escapeHtml(link.imageUrl)}" alt="${escapeHtml(title)}" loading="lazy" />`
          : `<div class="image-placeholder">No image</div>`;

        let priceHtml;
        if (typeof link.price === "number") {
          const formatted = link.price.toLocaleString("en-IN");
          priceHtml = `<div class="price-label">‚Çπ${formatted}</div>`;
        } else {
          priceHtml = `<div class="price-label">Best price on Amazon</div>`;
        }

        const created = link.createdAt
          ? new Date(link.createdAt)
          : null;
        const dateStr = created
          ? created.toLocaleDateString("en-IN", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            })
          : "";

        const clicks = typeof link.clicks === "number" ? link.clicks : 0;

        const affiliateUrl = link.affiliateUrl || `/api/links/go/${link.id}`;

        card.innerHTML = `
          <div class="product-badges">
            <span class="source-pill">${escapeHtml(sourceLabel)}</span>
            <span class="category-pill">${escapeHtml(categoryLabel)}</span>
          </div>

          <div class="product-media">
            ${imgHtml}
          </div>

          <div class="product-text">
            <div class="product-title">${escapeHtml(title)}</div>
            ${
              note
                ? `<div class="product-description">${escapeHtml(note)}</div>`
                : ""
            }
          </div>

          <div class="product-meta-row">
            <div>
              ${priceHtml}
              <div class="price-note">Final price shown on Amazon page</div>
            </div>
            <div style="text-align:right;">
              ${
                dateStr
                  ? `<div style="font-size:10px;">${dateStr}</div>`
                  : ""
              }
              <div class="clicks-pill">
                <strong>${clicks}</strong> click${clicks === 1 ? "" : "s"}
              </div>
            </div>
          </div>

          <div class="product-footer">
            <button class="cta-primary" data-href="${escapeHtml(
              affiliateUrl
            )}">Buy on Amazon</button>
            <button class="cta-secondary" data-copy="${escapeHtml(
              affiliateUrl
            )}">Copy link</button>
          </div>
        `;

        const buyBtn = card.querySelector(".cta-primary");
        const copyBtn = card.querySelector(".cta-secondary");

        buyBtn.addEventListener("click", () => {
          window.open(buyBtn.dataset.href, "_blank");
        });

        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(copyBtn.dataset.copy);
            copyBtn.textContent = "Copied!";
            setTimeout(() => {
              copyBtn.textContent = "Copy link";
            }, 1200);
          } catch (err) {
            console.error("Clipboard failed", err);
          }
        });

        gridEl.appendChild(card);
      });
    }

    // Category chip events
    document.querySelectorAll(".chip").forEach((chip) => {
      chip.addEventListener("click", () => {
        if (chip.classList.contains("active")) return;
        document.querySelectorAll(".chip").forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        applyFiltersAndRender();
      });
    });

    searchInput.addEventListener("input", () => {
      applyFiltersAndRender();
    });

    sortSelect.addEventListener("change", () => {
      applyFiltersAndRender();
    });

    document.addEventListener("DOMContentLoaded", loadProducts);
  </script>
</body>
</html>