<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AlwaysOnSale – Deals</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="store.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>
    <header class="store-shell">
      <div class="store-topbar">
        <div class="brand-pill">
          <span class="dot dot-live"></span>
          <span class="brand-text-1">ALWAYS</span>
          <span class="brand-text-2">ON</span>
          <span class="brand-text-3">SALE</span>
        </div>

        <nav class="store-nav">
          <a class="nav-link nav-link-active" href="/AlwaysOnSale">Store</a>
          <a class="nav-link" href="/">Dashboard (admin)</a>
        </nav>
      </div>

      <main class="store-main">
        <!-- Hero -->
        <section class="hero-card">
          <div class="hero-text">
            <h1>Today’s hand-picked deals</h1>
            <p class="hero-subtitle">
              Amazon engine, Instagram skin. Curated products with tracked
              links.
            </p>
          </div>
          <div class="hero-status">
            <div class="status-pill status-live">
              <span class="status-dot"></span>
              <span class="status-text">LIVE FROM ALWAYSonsale</span>
            </div>
            <p class="status-caption">
              Showing curated deals. Auto-updated via your affiliate dashboard.
            </p>
          </div>
        </section>

        <!-- Filters row -->
        <section class="filters-row">
          <div class="category-pills" id="category-pills">
            <!-- Pills will be injected here -->
          </div>

          <div class="search-sort-row">
            <div class="search-wrapper">
              <input
                id="search-input"
                type="search"
                placeholder="Search products or category..."
                autocomplete="off"
              />
            </div>
            <div class="sort-wrapper">
              <label class="sort-label" for="sort-select">Sort</label>
              <select id="sort-select">
                <option value="newest">Newest first</option>
                <option value="oldest">Oldest first</option>
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="clicks-desc">Most clicks</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Stats + error -->
        <section class="meta-row">
          <p id="stats-text" class="stats-text">Showing 0 deal(s).</p>
          <p id="error-text" class="error-text hidden">
            Could not load products. Please try again in a bit.
          </p>
        </section>

        <!-- Grid -->
        <section class="grid-shell">
          <div id="deals-grid" class="deals-grid">
            <!-- Cards injected via JS -->
          </div>
        </section>
      </main>

      <footer class="store-footer">
        <span>AlwaysOnSale · Amazon engine, Instagram skin.</span>
      </footer>
    </header>

    <script>
      // ---------- Config & helpers ----------
      const API_BASE = "/api/links";

      const CATEGORY_CONFIG = [
        { key: "all", label: "All" },
        { key: "clothing", label: "Clothing" },
        { key: "tshirts", label: "Tshirts" },
        { key: "shoes", label: "Shoes" },
        { key: "bags", label: "Bags" },
        { key: "electronics", label: "Electronics" },
        { key: "jeans", label: "Jeans" },
        { key: "laptops", label: "Laptops" },
        { key: "home & living", label: "Home & Living" },
        { key: "other", label: "Other" }
      ];

      const CATEGORY_LABELS = {
        clothing: "Clothing",
        tshirts: "Tshirts",
        shoes: "Shoes",
        bags: "Bags",
        electronics: "Electronics",
        jeans: "Jeans",
        laptops: "Laptops",
        "home & living": "Home & Living",
        "home_and_living": "Home & Living",
        other: "Other"
      };

      const state = {
        allLinks: [],
        filteredLinks: [],
        activeCategory: "all",
        searchQuery: "",
        sort: "newest"
      };

      const gridEl = document.getElementById("deals-grid");
      const statsEl = document.getElementById("stats-text");
      const errorEl = document.getElementById("error-text");
      const categoryPillsEl = document.getElementById("category-pills");
      const searchInputEl = document.getElementById("search-input");
      const sortSelectEl = document.getElementById("sort-select");

      function safeLower(str) {
        return (str || "").toString().toLowerCase();
      }

      function getCategoryKey(raw) {
        const key = safeLower(raw);
        if (!key) return "other";
        if (CATEGORY_LABELS[key]) return key;
        if (key === "home and living") return "home & living";
        return key;
      }

      function getCategoryLabel(raw) {
        const key = getCategoryKey(raw);
        if (CATEGORY_LABELS[key]) return CATEGORY_LABELS[key];
        const str = raw || "Other";
        return str
          .split(/[\s_]+/)
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function formatDate(value) {
        if (!value) return "";
        try {
          const d = new Date(value);
          return d.toLocaleDateString("en-IN", {
            day: "2-digit",
            month: "short",
            year: "numeric"
          });
        } catch {
          return "";
        }
      }

      function formatCurrency(amount, currency) {
        if (amount == null) return null;
        const cur = currency || "INR";
        try {
          return new Intl.NumberFormat("en-IN", {
            style: "currency",
            currency: cur,
            maximumFractionDigits: 0
          }).format(amount);
        } catch {
          return String(amount);
        }
      }

      function buildShareUrl(id) {
        const origin = window.location.origin;
        return origin + "/api/links/go/" + id;
      }

      // ---------- UI: categories, filters ----------
      function renderCategoryPills() {
        categoryPillsEl.innerHTML = "";
        CATEGORY_CONFIG.forEach((cfg) => {
          const btn = document.createElement("button");
          btn.className =
            "pill" + (cfg.key === state.activeCategory ? " pill-active" : "");
          btn.type = "button";
          btn.dataset.category = cfg.key;
          btn.textContent = cfg.label;
          btn.addEventListener("click", () => {
            state.activeCategory = cfg.key;
            renderCategoryPills();
            renderAll();
          });
          categoryPillsEl.appendChild(btn);
        });
      }

      function sortLinks(list) {
        const links = [...list];
        const sort = state.sort;

        if (sort === "newest" || sort === "oldest") {
          links.sort((a, b) => {
            const da = a.createdAt ? new Date(a.createdAt) : 0;
            const db = b.createdAt ? new Date(b.createdAt) : 0;
            return sort === "newest" ? db - da : da - db;
          });
        } else if (sort === "price-asc" || sort === "price-desc") {
          links.sort((a, b) => {
            const pa = a.price == null ? Number.POSITIVE_INFINITY : a.price;
            const pb = b.price == null ? Number.POSITIVE_INFINITY : b.price;
            return sort === "price-asc" ? pa - pb : pb - pa;
          });
        } else if (sort === "clicks-desc") {
          links.sort((a, b) => (b.clicks || 0) - (a.clicks || 0));
        }

        return links;
      }

      function applyFilters() {
        let list = state.allLinks.slice();

        // Category filter
        if (state.activeCategory !== "all") {
          const catKey = state.activeCategory;
          list = list.filter((link) => {
            const key = getCategoryKey(link.category);
            return key === catKey;
          });
        }

        // Search filter
        const q = safeLower(state.searchQuery).trim();
        if (q) {
          list = list.filter((link) => {
            return (
              safeLower(link.title).includes(q) ||
              safeLower(link.category).includes(q) ||
              safeLower(link.note).includes(q)
            );
          });
        }

        list = sortLinks(list);
        state.filteredLinks = list;
      }

      // ---------- UI: cards ----------
      function buildCardHtml(link) {
        const categoryLabel = getCategoryLabel(link.category);
        const created = formatDate(link.createdAt);

        // Description from AI-generated content if available, otherwise use note, then a default message
        const description =
          (link.longDescription && link.longDescription.trim()) ||
          (link.note && link.note.trim()) ||
          "This product is a simple, useful pick for daily life. Easy to add into your routine or lifestyle.";

        // Price block
        const priceLabel = formatCurrency(link.price, link.priceCurrency);
        const priceHtml = priceLabel
          ? `
          <div class="price-row">
            <div class="price-label">Best price on Amazon</div>
            <div class="price-amount">${priceLabel}</div>
          </div>
        `
          : `
          <div class="price-row">
            <div class="price-label muted">Best price on Amazon</div>
            <div class="price-amount subtle">Price not available</div>
          </div>
        `;

        const clicks = link.clicks || 0;
        const imageUrl =
          (link.imageUrl && link.imageUrl.trim()) ||
          (Array.isArray(link.images) && link.images.length
            ? link.images[0]
            : null);

        const imgSection = imageUrl
          ? `<img src="${imageUrl}" alt="${escapeHtml(
              link.title || "Product image"
            )}" loading="lazy" />`
          : `<div class="no-image">No image</div>`;

        const id = link.id || link._id;

        return `
          <article class="deal-card" data-id="${id}">
            <header class="deal-card-header">
              <span class="badge badge-source">${(link.source || "amazon")
                .toString()
                .toUpperCase()}</span>
              <span class="badge badge-category">${escapeHtml(
                categoryLabel
              )}</span>
            </header>

            <div class="deal-card-image">
              ${imgSection}
            </div>

            <div class="deal-card-body">
              <h2 class="deal-title">
                ${escapeHtml(link.title || "Product")}
              </h2>

              <p class="deal-description">
                ${escapeHtml(description)}
              </p>

              ${priceHtml}

              <div class="meta-row-card">
                ${
                  created
                    ? `<span class="meta-item">${created}</span>`
                    : `<span class="meta-item">Date unknown</span>`
                }
                <span class="meta-item">${clicks} click${
                  clicks === 1 ? "" : "s"
                }</span>
              </div>
            </div>

            <footer class="deal-card-footer">
              <button
                class="btn btn-primary"
                type="button"
                data-action="buy"
                data-id="${id}"
              >
                Buy on Amazon
              </button>
              <button
                class="btn btn-secondary"
                type="button"
                data-action="copy"
                data-id="${id}"
              >
                Copy link
              </button>
            </footer>
          </article>
        `;
      }

      function escapeHtml(str) {
        return (str || "")
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderAll() {
        applyFilters();

        const list = state.filteredLinks;
        statsEl.textContent = `Showing ${list.length} deal(s).`;

        gridEl.innerHTML = "";

        if (!list.length) {
          gridEl.innerHTML =
            '<div class="empty-state">No deals match your filters yet.</div>';
          return;
        }

        const fragments = list.map((link) => buildCardHtml(link)).join("");
        gridEl.innerHTML = fragments;

        wireCardButtons();
      }

      function wireCardButtons() {
        const buyButtons = gridEl.querySelectorAll('button[data-action="buy"]');
        const copyButtons = gridEl.querySelectorAll(
          'button[data-action="copy"]'
        );

        buyButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const url = `${API_BASE}/go/${id}`;
            window.open(url, "_blank", "noopener");
          });
        });

        copyButtons.forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!id) return;
            const shareUrl = buildShareUrl(id);

            try {
              await navigator.clipboard.writeText(shareUrl);
              btn.classList.add("copied");
              btn.textContent = "Copied!";
              setTimeout(() => {
                btn.classList.remove("copied");
                btn.textContent = "Copy link";
              }, 1200);
            } catch (err) {
              console.error("Clipboard error", err);
              alert("Link copied: " + shareUrl);
            }
          });
        });
      }

      // ---------- Data loading ----------
      async function fetchLinks() {
        errorEl.classList.add("hidden");
        try {
          const res = await fetch(`${API_BASE}/all`);
          if (!res.ok) {
            throw new Error("Bad response " + res.status);
          }
          const data = await res.json();
          if (!data || !Array.isArray(data.links)) {
            throw new Error("Unexpected API response");
          }
          state.allLinks = data.links;
          renderAll();
        } catch (err) {
          console.error("Error fetching links:", err);
          errorEl.classList.remove("hidden");
          gridEl.innerHTML =
            '<div class="empty-state error">Could not load products.</div>';
        }
      }

      // ---------- Event wiring ----------
      document.addEventListener("DOMContentLoaded", () => {
        renderCategoryPills();
        fetchLinks();

        searchInputEl.addEventListener("input", (e) => {
          state.searchQuery = e.target.value || "";
          renderAll();
        });

        sortSelectEl.addEventListener("change", (e) => {
          state.sort = e.target.value || "newest";
          renderAll();
        });
      });
    </script>
  </body>
</html>
